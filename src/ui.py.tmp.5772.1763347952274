# src/ui_html.py
import streamlit as st
import pandas as pd
from pandas.tseries.offsets import DateOffset
from typing import Tuple, Dict
from src.utils import to_excel
import base64
import streamlit.components.v1 as components # Import component HTML
import datetime # ThÃªm thÆ° viá»‡n datetime

# HÃ m setup_sidebar vÃ  create_download_link_html giá»¯ nguyÃªn nhÆ° cÅ©
def setup_sidebar() -> Tuple[DateOffset, str]:
    """
    CÃ i Ä‘áº·t vÃ  hiá»ƒn thá»‹ cÃ¡c widget trong sidebar, bao gá»“m cáº£ tÃ¹y chá»n tÃ¹y chá»‰nh ngÃ y.
    """
    st.sidebar.header("âš™ï¸ TÃ¹y chá»n PhÃ¢n tÃ­ch")

    # THÃŠM Láº I TÃ™Y CHá»ŒN 'TÃ¹y chá»‰nh'
    period_options = {
        '3 thÃ¡ng': (DateOffset(months=3), '3T'),
        '6 thÃ¡ng': (DateOffset(months=6), '6T'),
        '1 nÄƒm': (DateOffset(months=12), '1Y'),
        'TÃ¹y chá»‰nh': (None, 'Custom') # ThÃªm láº¡i tÃ¹y chá»n nÃ y
    }

    # Máº·c Ä‘á»‹nh váº«n lÃ  '6 thÃ¡ng'
    selected_period = st.sidebar.selectbox(
        "Chá»n khoáº£ng thá»i gian tÃ­nh hiá»‡u suáº¥t:",
        options=list(period_options.keys()),
        index=1
    )

    period_offset, period_label = period_options[selected_period]

    # THÃŠM Láº I LOGIC Xá»¬ LÃ CHO KHOáº¢NG THá»œI GIAN TÃ™Y CHá»ˆNH
    if selected_period == 'TÃ¹y chá»‰nh':
        today = datetime.date.today()
        # Máº·c Ä‘á»‹nh khoáº£ng thá»i gian lÃ  6 thÃ¡ng gáº§n nháº¥t
        default_start = today - datetime.timedelta(days=180)

        start_date = st.sidebar.date_input("NgÃ y báº¯t Ä‘áº§u", default_start)
        end_date = st.sidebar.date_input("NgÃ y káº¿t thÃºc", today)

        if start_date >= end_date:
            st.sidebar.error("NgÃ y báº¯t Ä‘áº§u pháº£i trÆ°á»›c ngÃ y káº¿t thÃºc.")
            # Tráº£ vá» giÃ¡ trá»‹ máº·c Ä‘á»‹nh (6 thÃ¡ng) Ä‘á»ƒ trÃ¡nh lá»—i
            return period_options['6 thÃ¡ng']

        # TÃ­nh toÃ¡n khoáº£ng chÃªnh lá»‡ch thá»i gian
        delta = end_date - start_date
        period_offset = DateOffset(days=delta.days)
        period_label = f'{delta.days}D' # NhÃ£n sáº½ hiá»ƒn thá»‹ sá»‘ ngÃ y

    # ThÃªm chÃº thÃ­ch vá» cÃ¡ch xÃ¡c Ä‘á»‹nh Win Rate
    st.sidebar.markdown("---")
    st.sidebar.header("ğŸ“Š CÃ¡ch XÃ¡c Äá»‹nh Win Rate")
    st.sidebar.markdown("""
    **NguyÃªn táº¯c chung:**
    - Winrate = (Sá»‘ láº§n dá»± Ä‘oÃ¡n Ä‘Ãºng / Tá»•ng sá»‘ khuyáº¿n nghá»‹) Ã— 100%
    - So sÃ¡nh hiá»‡u suáº¥t cá»• phiáº¿u vá»›i chá»‰ sá»‘ VNINDEX

    **Chi tiáº¿t tá»«ng cá»™t:**

    ğŸ“‰ **OUTPERFORM â†’ MARKET-PERFORM**
    - Äáº¿m % sá»‘ láº§n cá»• phiáº¿u **UNDERPERFORM** VNINDEX
    - Winrate cao = Quyáº¿t Ä‘á»‹nh háº¡ khuyáº¿n nghá»‹ chÃ­nh xÃ¡c

    ğŸš€ **MARKET-PERFORM â†’ OUTPERFORM**
    - Äáº¿m % sá»‘ láº§n cá»• phiáº¿u **OUTPERFORM** VNINDEX
    - Winrate cao = Quyáº¿t Ä‘á»‹nh nÃ¢ng khuyáº¿n nghá»‹ chÃ­nh xÃ¡c

    âœ… **Khuyáº¿n nghá»‹ BUY**
    - Äáº¿m % sá»‘ láº§n cá»• phiáº¿u **OUTPERFORM** VNINDEX
    - Winrate cao = Khuyáº¿n nghá»‹ mua chÃ­nh xÃ¡c

    âš ï¸ **Khuyáº¿n nghá»‹ UNDER-PERFORM**
    - Äáº¿m % sá»‘ láº§n cá»• phiáº¿u **UNDERPERFORM** VNINDEX
    - Winrate cao = Khuyáº¿n nghá»‹ underperform chÃ­nh xÃ¡c
    """)

    return period_offset, period_label

def create_download_link_html(df_dict: dict, filename: str, link_text: str) -> str:
    excel_data = to_excel(df_dict)
    b64 = base64.b64encode(excel_data).decode()
    return f'<a href="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{b64}" download="{filename}" class="download-button">{link_text}</a>'


def display_results_html(results: Dict[str, pd.DataFrame], summary_df: pd.DataFrame, period_label: str):
    """
    Hiá»ƒn thá»‹ káº¿t quáº£ phÃ¢n tÃ­ch, tÃ¹y chá»‰nh Ä‘á»™ rá»™ng cá»™t cho cÃ¡c báº£ng chi tiáº¿t.
    """
    
    # --- CÃ¡c hÃ m vÃ  logic xá»­ lÃ½ DataFrame (khÃ´ng Ä‘á»•i) ---
    # ... (pháº§n code nÃ y giá»¯ nguyÃªn) ...
    def style_rating(val):
        color = ''
        if val == 'Outperform': color = '#D4EDDA'
        elif val == 'Underperform': color = '#F8D7DA'
        return f'background-color: {color}'

    def style_win_rate(val):
        color = ''
        if isinstance(val, str) and '%' in val:
            try:
                num_val = float(val.split(' ')[0].strip('%'))
                if num_val > 50: color = '#D4EDDA'
                elif num_val < 50: color = '#F8D7DA'
            except (ValueError, TypeError): pass
        return f'background-color: {color}'

    if not summary_df.empty:
        win_rate_cols = summary_df.columns.drop('Win Rate')
        summary_styler = summary_df.style.apply(lambda x: x.map(style_win_rate), subset=win_rate_cols)
        summary_html = summary_styler.hide(axis="index").to_html(embed_css=True)
    else:
        summary_html = "<p>KhÃ´ng cÃ³ Ä‘á»§ dá»¯ liá»‡u Ä‘á»ƒ táº¡o báº£ng thá»‘ng kÃª Win Rate.</p>"

    results_html = {}
    for name, df in results.items():
        if not df.empty:
            numeric_cols = [col for col in df.columns if 'Hiá»‡u suáº¥t' in col or 'vs VNINDEX' in col]
            styler = df.style.map(style_rating, subset=['Rating'])
            styler.set_properties(**{'text-align': 'right'}, subset=numeric_cols)
            results_html[name] = styler.hide(axis="index").to_html(embed_css=True)
        else:
            results_html[name] = f"<p>KhÃ´ng cÃ³ dá»¯ liá»‡u cho má»¥c nÃ y.</p>"
            
    dfs_for_export = {"Thong_ke_Win_Rate": summary_df, **results}
    download_filename = f"ket_qua_loc_co_phieu_{period_label}.xlsx"
    download_button_html = create_download_link_html(dfs_for_export, download_filename, "ğŸ“ Táº£i file Excel")


    # --- MÃ£ HTML vÃ  CSS ---
    html_template = f"""
    <!DOCTYPE html>
    <html>
    <head>
    <style>
        .container {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            width: 100%;
        }}
        h3, h4 {{
            color: #0d3b66;
            border-bottom: 2px solid #f4d35e;
            padding-bottom: 5px;
            margin-top: 25px;
        }}
        h4 > a {{
            text-decoration: none;
            color: inherit;
        }}
        .grid-container {{
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }}
        .grid-item {{
            width: 100%;
        }}
        .table-container {{
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
            table-layout: fixed; /* GiÃºp CSS width hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh */
        }}
        th, td {{
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word; /* Chá»‘ng vá»¡ layout náº¿u ná»™i dung quÃ¡ dÃ i */
        }}
        th {{
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }}
        .winrate-table table th, .winrate-table table td {{
            text-align: right;
        }}
        .winrate-table table th:first-child, .winrate-table table td:first-child {{
            text-align: left;
        }}
        .download-section {{
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
        }}
        .download-button {{ /* ... */ }}

        /* >>> THÃŠM Má»šI: CSS Äá»‚ TÃ™Y CHá»ˆNH Äá»˜ Rá»˜NG Cá»˜T <<< */
        .table-container th:nth-child(1), .table-container td:nth-child(1) {{ width: 13%; }} /* Cá»• phiáº¿u */
        .table-container th:nth-child(2), .table-container td:nth-child(2) {{ width: 18%; }} /* NgÃ y */
        .table-container th:nth-child(3), .table-container td:nth-child(3) {{ width: 15%; }} /* Hiá»‡u suáº¥t CP */
        .table-container th:nth-child(4), .table-container td:nth-child(4) {{ width: 15%; }} /* Hiá»‡u suáº¥t VNINDEX */
        .table-container th:nth-child(5), .table-container td:nth-child(5) {{ width: 15%; }} /* vs VNINDEX */
        .table-container th:nth-child(6), .table-container td:nth-child(6) {{ width: 20%; }} /* Rating */

    </style>
    </head>
    <body>
    <div class="container">
        <h3>ğŸ“Š Win Rate</h3>
        <div class="winrate-table">
            {summary_html}
        </div>

        
        <div class="grid-container">
            <div class="grid-item">
                <h4>ğŸ“‰ OUTPERFORM to MARKET-PERFORM</h4>
                <div class="table-container">{results_html["Out_sang_MarketPerform"]}</div>
            </div>
            <div class="grid-item">
                <h4>ğŸš€ MARKET-PERFORM to OUTPERFORM</h4>
                <div class="table-container">{results_html["MarketPerform_sang_Out"]}</div>
            </div>
            <div class="grid-item">
                <h4>âœ… Khuyáº¿n nghá»‹ BUY</h4>
                <div class="table-container">{results_html["Khuyen_nghi_BUY"]}</div>
            </div>
            <div class="grid-item">
                <h4>âš ï¸ Khuyáº¿n nghá»‹ UNDER-PERFORM</h4>
                <div class="table-container">{results_html["Khuyen_nghi_UnderPerform"]}</div>
            </div>
        </div>
        
        <div class="download-section">
            <h3>ğŸ“¥ Táº£i xuá»‘ng káº¿t quáº£</h3>
            {download_button_html}
        </div>
    </div>
    </body>
    </html>
    """

    # --- Lá»‡nh hiá»ƒn thá»‹ (khÃ´ng Ä‘á»•i) ---
    components.html(html_template, height=1800)